<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" user-scalable=no">
  <title>食券販売アプリ</title>
  <style>
    
    @import url('https://fonts.googleapis.com/css2?family=Murecho:wght@400;700&display=swap');
body{font-family:Murecho,sans-serif;}
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      color:black;
      text-align: center;
      touch-action: none;
      overscroll-behavior: none;
      background-color: #e3a688;
    }

    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .total {
      font-size: 60px;
      border: 2px solid #333;
      padding: 0px;
      width: 94%;
      background-color: #f9f5f5;
      margin-bottom: 30px;
    }

    .buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 20px;
      width: 100vw;
      max-width: 1000px;
      margin-bottom: 30px;
    }

.item-btn {
  width: 45%;
  height: auto;
  font-size: 18px;
  position: relative;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px;
  gap: 10px;
  border-radius: 10px;
}
    button {
      color:#111;
      background-color:#ffffff00;
      border: none;
    }
    button:hover {
      background-color:#ffffff11;
    }
    button:active{
      background-color:#00000011;
    }

.item-btn > button:first-child {
  width: 105%;
  height: 25vh;
  font-size: 50px;
}

.item-btn button:last-child {
  background-color: #ff7777;
  color: white;
  border: none;
  padding: 10px;
  width: 100%;
  font-size: 16px;
  cursor: pointer;
}


    .count {
      position: absolute;
      top: 5px;
      right: 10px;
      background: #ff4444;
      color: white;
      border-radius: 10%;
      width: 50px;
      height: 50px;
      line-height: 30px;
      font-size: 34px;
    }
    #b1 {background-color:#80bfb5}
    #b2 {background-color:#9e6d36}
    #b3 {background-color:#d67ea2}
    #b4 {background-color:#4ea651}
    #resetBtn {
      font-size: 30px;
      padding: 10px 20px;
      border: solid;
    }
    #dbBtn {
      font-size:30px;
      padding: 5px 20px;
      border:solid;
      background-color:#3fd17e66;
    }
    #sendBtn {
      font-size:30px;
      padding: 5px 20px;
      border:solid;
      background-color:#ff564a;
    }
  </style>
</head>
<body>

  <div class="total">合計: ¥<span id="total">0</span></div>

<div class="buttons">
  <div class="item-btn" id="b1">
    <button onclick="addItem('plain')">プレーン ¥150</button>
    <span class="count" id="plainCount">0</span>
    <button onclick="removeItem('plain')">1つキャンセル</button>
  </div>
  <div class="item-btn" id="b2">
    <button onclick="addItem('choco')">チョコアイス ¥250</button>
    <span class="count" id="chocoCount">0</span>
    <button onclick="removeItem('choco')">1つキャンセル</button>
  </div>
  <div class="item-btn" id="b3">
    <button onclick="addItem('strawberry')">いちごアイス ¥250</button>
    <span class="count" id="strawberryCount">0</span>
    <button onclick="removeItem('strawberry')">1つキャンセル</button>
  </div>
  <div class="item-btn" id="b4">
    <button onclick="addItem('matcha')">抹茶あんこアイス ¥250</button>
    <span class="count" id="matchaCount">0</span>
    <button onclick="removeItem('matcha')">1つキャンセル</button>
  </div>
</div>

<div class="buttons">
  <button id="resetBtn" onclick="resetAll()">リセット</button>
  <button id="dbBtn" onclick="window.open('https://docs.google.com/spreadsheets/d/1rJj1GMGcRV4MXAvEyhgI9jZMvGzNmJudf3AB-H_BXJs/edit?usp=sharing', '_blank')">
  データベース
</button>
<button id="sendBtn" onclick="sendDataToSheet()">
  <b>注文を送信</b>
</button>
  </div>
  <script>
    const items = {
      plain: { price: 150, count: 0 },
      choco: { price: 250, count: 0 },
      strawberry: { price: 250, count: 0 },
      matcha: { price: 250, count: 0 }
    };

    function addItem(key) {
      items[key].count++;
      updateDisplay();
    }

    function updateDisplay() {
      let total = 0;
      for (const key in items) {
        const item = items[key];
        document.getElementById(key + 'Count').textContent = item.count;
        total += item.price * item.count;
      }
      document.getElementById('total').textContent = total;
    }

    function resetAll() {
      for (const key in items) {
        items[key].count = 0;
      }
      updateDisplay();
    }
function removeItem(key) {
  if (items[key].count > 0) {
    items[key].count--;
    updateDisplay();
  }
}

async function sendDataToSheet() {
  const data = {
    plain: items.plain.count,
    choco: items.choco.count,
    strawberry: items.strawberry.count,
    matcha: items.matcha.count,
    total: Object.keys(items).reduce((sum, key) => sum + items[key].price * items[key].count, 0)
  };

  // UIリセットは即時実行（送信前）
  const backup = JSON.parse(JSON.stringify(items)); // 念のためバックアップ
  resetAll();

  try {
    // ① 在庫取得
    const res = await fetch('https://script.google.com/macros/s/AKfycbxMkoBBE597bIelB7ymvSLG_1fRCGijKcebZj6hutthFa4KhnbV5NzuntxghZbn8hQJ/exec');
    const stock = await res.json();

    // ② 在庫チェック
    for (const key in data) {
      if (key === "total") continue;
      if (data[key] > stock[key]) {
        alert(`${key} の在庫が足りません！`);
        // 在庫が足りなければ元に戻す
        Object.assign(items, backup);
        updateDisplay();
        return;
      }
    }

    // ③ データ送信
    await fetch('https://script.google.com/macros/s/AKfycbxMkoBBE597bIelB7ymvSLG_1fRCGijKcebZj6hutthFa4KhnbV5NzuntxghZbn8hQJ/exec', {
      method: 'POST',
      mode: 'no-cors',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(data)
    });

    // ④ 在庫更新に基づいてボタン無効化
    for (const key in stock) {
      const remaining = stock[key] - data[key];
      if (remaining <= 0) {
        const buttons = document.querySelectorAll(`[onclick*="${key}"]`);
        buttons.forEach(btn => btn.disabled = true);
      }
    }

    // 成功時は通知なし or console.logだけ
    console.log("注文送信成功");

  } catch (err) {
    alert("送信に失敗しました。");
    // 失敗したら元に戻す（必要であれば）
    Object.assign(items, backup);
    updateDisplay();
  }
}


        // モバイルのタッチイベントを完全に無効化
    document.addEventListener('touchstart', function(e) {
      e.preventDefault();
    }, { passive: false });

    document.addEventListener('touchmove', function(e) {
      e.preventDefault();
    }, { passive: false });

    document.addEventListener('gesturestart', function(e) {
      e.preventDefault(); // iOS Safari のピンチ開始イベント
    });
  </script>

</body>
</html>
